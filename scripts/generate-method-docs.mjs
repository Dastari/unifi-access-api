import { fileURLToPath } from 'url';
import path from 'path';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

const distEndpointPath = path.resolve(rootDir, 'dist/esm/endpoints/index.js');
if (!fs.existsSync(distEndpointPath)) {
  console.error('Compiled endpoints not found at', distEndpointPath);
  console.error('Run `npm run build` before generating method documentation.');
  process.exit(1);
}

const { endpointDefinitions } = await import(pathToFileURL(distEndpointPath));

function pathToFileURL(p) {
  const url = new URL('file://');
  url.pathname = path.resolve(p).replace(/\\/g, '/');
  return url;
}

const entries = Object.entries(endpointDefinitions);

const targetFile = path.resolve(rootDir, 'src/unifi-access-api.docs.ts');
const header = `// Auto-generated by scripts/generate-method-docs.mjs. Do not edit manually.\n`;
const imports = `import type { EndpointInvoker } from './internal/endpoint.js';\nimport type { endpointDefinitions } from './endpoints/index.js';\n\n`;

const lines = [header, imports, `declare module './client.js' {\n  interface UnifiAccessApi {\n`];

for (const [name, def] of entries) {
  const method = def.method ?? 'GET';
  const route = def.path ?? '';
  const readableName = name
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, (c) => c.toUpperCase())
    .trim();
  lines.push('    /**');
  lines.push(`     * ${readableName}.`);
  if (route) {
    lines.push(`     *`);
    lines.push(`     * Performs a ${method} request to \`${route}\`.`);
  }
  lines.push('     *');
  lines.push('     * @returns Promise resolving with the typed API response.');
  lines.push('     */');
  lines.push(`    readonly ${name}: EndpointInvoker<(typeof endpointDefinitions)['${name}']>;`);
  lines.push('');
}
lines.push('  }');
lines.push('}\n');

fs.writeFileSync(targetFile, lines.join('\n'));
console.log('Generated documentation augmentation at', path.relative(rootDir, targetFile));
